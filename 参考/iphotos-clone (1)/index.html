<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Photos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Import Google GenAI SDK for module usage -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
    "react": "https://esm.sh/react@^19.2.4"
  }
}
</script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: black;
            color: white;
            overflow: hidden; /* Prevent body scroll when in detail view */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Carousel Styles */
        #detail-view {
            transition: opacity 0.3s ease;
        }
        
        #carousel-track {
            display: flex;
            height: 100%;
            width: 300%; /* 3 panels: Prev, Current, Next */
            margin-left: -100%; /* Start at center panel */
            will-change: transform;
        }

        .carousel-item {
            width: 33.333%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .carousel-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none; /* Let clicks pass through to container */
            user-select: none;
        }

        /* Safe Area Utilities */
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .hidden { display: none !important; }
        .opacity-0 { opacity: 0; pointer-events: none; }
        .opacity-100 { opacity: 1; pointer-events: auto; }
        
        /* Scrubber active state */
        .thumb-active {
            opacity: 1 !important;
            transform: scale(1.1);
            border: 2px solid white;
            z-index: 10;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="app" class="h-screen flex flex-col relative overflow-hidden">
        
        <!-- === LIBRARY VIEW === -->
        <div id="library-view" class="flex-1 flex flex-col h-full overflow-y-auto no-scrollbar">
            <!-- Header -->
            <header id="library-header" class="fixed top-0 left-0 right-0 z-40 bg-black/80 backdrop-blur-md pt-safe transition-all duration-300">
                <div class="px-4 py-3 flex justify-between items-center border-b border-gray-800">
                    <h1 class="text-3xl font-bold tracking-tight">Library</h1>
                    <button class="text-blue-500 font-medium text-base bg-gray-900/50 px-3 py-1 rounded-full">Select</button>
                </div>
                <div class="flex gap-4 px-4 py-3 text-sm font-medium">
                    <button class="bg-gray-200 text-black px-3 py-1 rounded-full">All Photos</button>
                    <button class="text-gray-400">Days</button>
                    <button class="text-gray-400">Months</button>
                    <button class="text-gray-400">Years</button>
                </div>
            </header>

            <!-- Grid -->
            <main class="pt-[140px] pb-24 px-1">
                <div id="photo-grid" class="grid grid-cols-3 gap-0.5 md:grid-cols-4 lg:grid-cols-6">
                    <!-- Photos injected here -->
                </div>
                <div class="mt-8 text-center text-gray-500 text-sm pb-8">
                    <p id="photo-count" class="font-medium text-gray-400">0 Photos</p>
                    <p class="text-xs mt-1">Synced with iCloud</p>
                </div>
            </main>

            <!-- Tab Bar -->
            <nav class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-xl border-t border-gray-800 pb-safe pt-2 px-6 flex justify-between items-center z-40">
                <button class="flex flex-col items-center gap-1 w-16 text-blue-500">
                    <i data-lucide="library" width="24" height="24"></i>
                    <span class="text-[10px] font-medium">Library</span>
                </button>
                <button class="flex flex-col items-center gap-1 w-16 text-gray-500">
                    <i data-lucide="user" width="24" height="24"></i>
                    <span class="text-[10px] font-medium">For You</span>
                </button>
                <button class="flex flex-col items-center gap-1 w-16 text-gray-500">
                    <i data-lucide="layers" width="24" height="24"></i>
                    <span class="text-[10px] font-medium">Albums</span>
                </button>
                <button class="flex flex-col items-center gap-1 w-16 text-gray-500">
                    <i data-lucide="search" width="24" height="24"></i>
                    <span class="text-[10px] font-medium">Search</span>
                </button>
            </nav>
        </div>

        <!-- === DETAIL VIEW (Hidden by default) === -->
        <div id="detail-view" class="fixed inset-0 z-50 bg-black hidden flex flex-col h-full">
            
            <!-- Top Controls -->
            <div id="detail-top-bar" class="absolute top-0 left-0 right-0 p-4 pt-safe flex justify-between items-center z-20 bg-gradient-to-b from-black/80 to-transparent transition-opacity duration-300">
                <button id="btn-back" class="text-white p-2 hover:text-gray-300"><i data-lucide="chevron-left" width="32" height="32"></i></button>
                <div class="flex flex-col items-center drop-shadow-md">
                    <span id="detail-date" class="text-sm font-semibold text-white/90"></span>
                    <span id="detail-time" class="text-xs text-white/70"></span>
                </div>
                <button class="text-blue-500 font-semibold p-2">Edit</button>
            </div>

            <!-- Carousel Area -->
            <div id="carousel-container" class="flex-1 relative overflow-hidden bg-black w-full touch-none cursor-grab active:cursor-grabbing">
                <div id="carousel-track">
                    <!-- 3 Panels for Infinite Scroll -->
                    <div class="carousel-item" id="panel-prev">
                        <img src="" alt="" draggable="false">
                    </div>
                    <div class="carousel-item" id="panel-curr">
                        <img src="" alt="" draggable="false">
                    </div>
                    <div class="carousel-item" id="panel-next">
                        <img src="" alt="" draggable="false">
                    </div>
                </div>
            </div>

            <!-- Bottom Controls Container -->
            <div id="detail-controls" class="transition-opacity duration-300">
                
                <!-- Scrubber -->
                <div class="bg-black/90 backdrop-blur-sm z-10 w-full border-t border-gray-800/50">
                    <div id="scrubber-track" class="flex gap-1 overflow-x-auto px-4 py-3 no-scrollbar items-center snap-x">
                        <!-- Thumbnails injected here -->
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="bg-black/90 backdrop-blur-xl border-t border-gray-800 pb-safe px-6 py-3 flex justify-between items-center z-10">
                    <button class="text-blue-500 p-2"><i data-lucide="share" width="24" height="24"></i></button>
                    <button id="btn-like" class="text-white/80 p-2"><i data-lucide="heart" width="24" height="24"></i></button>
                    <button id="btn-info" class="text-white/80 p-2"><i data-lucide="info" width="24" height="24"></i></button>
                    <button class="text-white/80 p-2"><i data-lucide="trash-2" width="24" height="24"></i></button>
                </div>
            </div>

            <!-- Info Sheet (Visual Look Up) -->
            <div id="info-sheet" class="hidden absolute bottom-[160px] left-4 right-4 bg-gray-800/90 backdrop-blur-xl rounded-2xl p-4 text-white border border-gray-600/50 shadow-2xl animate-slide-up z-30">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-lg flex items-center gap-2">
                        Visual Look Up
                        <span class="text-xs font-normal text-gray-400 bg-gray-900 px-2 py-0.5 rounded-full">AI</span>
                    </h3>
                    <button id="btn-close-info" class="text-gray-400"><i data-lucide="x" width="16" height="16"></i></button>
                </div>
                <div class="min-h-[60px]" id="info-content">
                    <!-- Analysis text goes here -->
                </div>
                <div class="mt-4 pt-3 border-t border-gray-600/50 grid grid-cols-2 gap-4 text-xs text-gray-400">
                    <div>
                        <span class="block text-gray-500 uppercase tracking-wider text-[10px] mb-1">Camera</span>
                        iPhone 15 Pro
                    </div>
                    <div>
                        <span class="block text-gray-500 uppercase tracking-wider text-[10px] mb-1">Dimensions</span>
                        3024 x 4032
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- STATE & DATA ---
        let photos = [];
        let currentIndex = 0;
        let isControlsVisible = true;
        let isInfoVisible = false;
        let analyzedPhotoId = null; // Track which photo has been analyzed to avoid re-calls

        // Generate Photos
        function generatePhotos(count) {
            return Array.from({ length: count }).map((_, i) => ({
                id: i.toString(),
                url: `https://picsum.photos/id/${10 + i}/800/1200`,
                thumbnail: `https://picsum.photos/id/${10 + i}/400/400`,
                date: new Date(Date.now() - i * 86400000).toLocaleDateString('en-US', { month: 'long', day: 'numeric' }),
                location: ['San Francisco', 'New York', 'Tokyo', 'London', 'Paris', 'Berlin'][i % 6]
            }));
        }

        // --- DOM ELEMENTS ---
        const libraryView = document.getElementById('library-view');
        const photoGrid = document.getElementById('photo-grid');
        const detailView = document.getElementById('detail-view');
        const carouselTrack = document.getElementById('carousel-track');
        const scrubberTrack = document.getElementById('scrubber-track');
        const panelPrev = document.getElementById('panel-prev').querySelector('img');
        const panelCurr = document.getElementById('panel-curr').querySelector('img');
        const panelNext = document.getElementById('panel-next').querySelector('img');
        const infoSheet = document.getElementById('info-sheet');
        const infoContent = document.getElementById('info-content');

        // --- INITIALIZATION ---
        function init() {
            photos = generatePhotos(24);
            document.getElementById('photo-count').innerText = `${photos.length} Photos, 0 Videos`;
            renderGrid();
            lucide.createIcons();
        }

        function renderGrid() {
            photoGrid.innerHTML = photos.map((photo, index) => `
                <div class="relative aspect-square overflow-hidden bg-gray-900 cursor-pointer active:opacity-70 transition-opacity" 
                     onclick="openDetail(${index})">
                    <img src="${photo.thumbnail}" class="w-full h-full object-cover" loading="lazy" />
                </div>
            `).join('');
        }

        // --- GEMINI SERVICE ---
        async function analyzeCurrentPhoto() {
            const photo = photos[currentIndex];
            if (analyzedPhotoId === photo.id) return; // Already analyzed this specific photo
            
            infoContent.innerHTML = `
                <div class="flex items-center gap-2 text-gray-400 text-sm">
                    <div class="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>
                    Analyzing photo...
                </div>
            `;
            
            try {
                // Fetch Base64
                const response = await fetch(photo.url);
                const blob = await response.blob();
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                });

                // Call API
                const apiKey = process.env.API_KEY;
                if(!apiKey) throw new Error("No API Key");
                
                const ai = new GoogleGenAI({ apiKey });
                const result = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: {
                        parts: [
                            { inlineData: { mimeType: 'image/jpeg', data: base64 } },
                            { text: "Analyze this image briefly. Describe what is happening, the mood, and identify any main objects or landmarks. Keep it under 50 words." }
                        ]
                    }
                });
                
                infoContent.innerHTML = `<p class="text-sm text-gray-200 leading-relaxed">${result.text}</p>`;
                analyzedPhotoId = photo.id;

            } catch (error) {
                console.error(error);
                infoContent.innerHTML = `<p class="text-sm text-red-400">Unable to analyze photo. ${error.message}</p>`;
            }
        }

        // --- DETAIL VIEW LOGIC ---
        window.openDetail = (index) => {
            currentIndex = index;
            updateCarouselImages();
            renderScrubber();
            
            detailView.classList.remove('hidden');
            // Hide info sheet by default when opening
            isInfoVisible = false;
            infoSheet.classList.add('hidden');
            analyzedPhotoId = null;
            
            // Force reflow for transition
            requestAnimationFrame(() => {
                detailView.style.opacity = '1';
            });
        };

        window.closeDetail = () => {
            detailView.style.opacity = '0';
            setTimeout(() => {
                detailView.classList.add('hidden');
            }, 300);
        };

        document.getElementById('btn-back').onclick = window.closeDetail;

        function updateCarouselImages() {
            const curr = photos[currentIndex];
            const prev = photos[currentIndex - 1];
            const next = photos[currentIndex + 1];

            panelCurr.src = curr.url;
            panelPrev.src = prev ? prev.url : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // transparent pixel
            panelNext.src = next ? next.url : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

            // Update Text
            document.getElementById('detail-date').innerText = curr.date;
            document.getElementById('detail-time').innerText = curr.location;

            // Update Scrubber UI
            updateScrubberActiveState();

            // If info is open, re-analyze
            if (isInfoVisible) {
                analyzeCurrentPhoto();
            }
        }

        function renderScrubber() {
            scrubberTrack.innerHTML = photos.map((p, idx) => `
                <button onclick="jumpToPhoto(${idx})" 
                        id="thumb-${idx}"
                        class="flex-shrink-0 relative transition-all duration-200 snap-center w-8 h-12 opacity-50 overflow-hidden">
                    <img src="${p.thumbnail}" class="w-full h-full object-cover pointer-events-none" />
                </button>
            `).join('');
            
            // Scroll to active
            setTimeout(() => {
                const activeEl = document.getElementById(`thumb-${currentIndex}`);
                if(activeEl) activeEl.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
            }, 0);
        }

        function updateScrubberActiveState() {
            // Remove active class from all
            document.querySelectorAll('#scrubber-track button').forEach(el => {
                el.classList.remove('thumb-active');
                el.classList.add('opacity-50');
            });
            
            const activeEl = document.getElementById(`thumb-${currentIndex}`);
            if (activeEl) {
                activeEl.classList.add('thumb-active');
                activeEl.classList.remove('opacity-50');
                activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        window.jumpToPhoto = (index) => {
            currentIndex = index;
            updateCarouselImages();
        };

        // --- UI CONTROLS ---
        function toggleControls() {
            isControlsVisible = !isControlsVisible;
            const topBar = document.getElementById('detail-top-bar');
            const bottom = document.getElementById('detail-controls');
            
            const opacity = isControlsVisible ? '1' : '0';
            const pointer = isControlsVisible ? 'auto' : 'none';
            
            topBar.style.opacity = opacity;
            topBar.style.pointerEvents = pointer;
            bottom.style.opacity = opacity;
            bottom.style.pointerEvents = pointer;
        }

        // Info Button
        document.getElementById('btn-info').onclick = () => {
            isInfoVisible = !isInfoVisible;
            if (isInfoVisible) {
                infoSheet.classList.remove('hidden');
                analyzeCurrentPhoto();
            } else {
                infoSheet.classList.add('hidden');
            }
        };

        document.getElementById('btn-close-info').onclick = () => {
            isInfoVisible = false;
            infoSheet.classList.add('hidden');
        };

        // Like Button (Visual Toggle)
        document.getElementById('btn-like').onclick = function() {
            const icon = this.querySelector('svg');
            if (this.classList.contains('text-red-500')) {
                this.classList.remove('text-red-500');
                this.classList.add('text-white/80');
                icon.setAttribute('fill', 'none');
                icon.setAttribute('stroke', 'currentColor');
            } else {
                this.classList.add('text-red-500');
                this.classList.remove('text-white/80');
                icon.setAttribute('fill', '#ef4444');
                icon.setAttribute('stroke', '#ef4444');
            }
        }

        // --- CAROUSEL DRAG LOGIC ---
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        const container = document.getElementById('carousel-container');

        container.addEventListener('pointerdown', (e) => {
            // Only left click
            if (e.button !== 0) return;
            
            isDragging = true;
            startX = e.clientX;
            currentX = e.clientX;
            
            carouselTrack.style.transition = 'none';
            container.setPointerCapture(e.pointerId);
        });

        container.addEventListener('pointermove', (e) => {
            if (!isDragging) return;
            currentX = e.clientX;
            const delta = currentX - startX;
            
            // Add resistance at edges
            let effectiveDelta = delta;
            if ((currentIndex === 0 && delta > 0) || (currentIndex === photos.length - 1 && delta < 0)) {
                effectiveDelta = delta * 0.3;
            }

            // Move the track (base offset is -100% for center alignment)
            // But since we are using transform, we just translate X pixels relative to the static layout
            carouselTrack.style.transform = `translateX(${effectiveDelta}px)`;
        });

        container.addEventListener('pointerup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            container.releasePointerCapture(e.pointerId);

            const delta = currentX - startX;
            const width = container.clientWidth;
            const threshold = width * 0.25;

            // Handle Tap (Toggle Controls)
            if (Math.abs(delta) < 5) {
                carouselTrack.style.transform = `translateX(0px)`;
                toggleControls();
                return;
            }

            // Determine Snap Direction
            let targetOffset = 0;
            let direction = 0; // -1 prev, 0 stay, 1 next

            if (delta < -threshold && currentIndex < photos.length - 1) {
                // Swipe Left -> Next
                targetOffset = -width - 24; // Width + Gap (approx)
                direction = 1;
            } else if (delta > threshold && currentIndex > 0) {
                // Swipe Right -> Prev
                targetOffset = width + 24;
                direction = -1;
            }

            // Animate Snap
            carouselTrack.style.transition = 'transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)';
            carouselTrack.style.transform = `translateX(${targetOffset}px)`;

            // After animation, update index and reset track
            const handleTransitionEnd = () => {
                carouselTrack.removeEventListener('transitionend', handleTransitionEnd);
                
                if (direction !== 0) {
                    currentIndex += direction;
                    updateCarouselImages();
                }
                
                // Instantly reset position to center (0px relative to layout)
                carouselTrack.style.transition = 'none';
                carouselTrack.style.transform = 'translateX(0px)';
            };

            carouselTrack.addEventListener('transitionend', handleTransitionEnd);
        });

        // Run Init
        init();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>